<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<title>Консоль в Windows</title>
		<style>
		.quote{
			font-family:monospace;
			margin:10px;
		}
		.side-note{
			text-align:right;
			display:block;
		}
		</style>
	</head>
	<body>
	<h2>Консоль в Windows — никому не нужна?</h2>
<span class="side-note">Опубликовано: 27 мая 2009</span>
<span class="side-note"><a href="https://geektimes.ru/post/60604/">Источник</a></span>
<p>Очень часто приходилось слышать такое от людей, которые много времени проводят за администрированием и другими IT-забавами.</p>

<p>Я, за не очень долгий опыт реального администрирования пришел к обратному выводу. В консоли (командной строке) В Windows можно выполнять очень много разных операций, которые стандартными возможностями не выполняются или выполняются некорректно/неудобно/долго (нужное подчеркнуть)</p>

<p>Совсем недавно где-то на Хабре промелькнуло высказывание из серии «Не думал, что консоль в Виндах что-то может. Хотелось бы узнать об этом побольше».</p>

<p>Вот так и возникло желание написать небольшую статью про основные возможности консоли.</p>

<p>Про самые стандартные команды консоли можно узнать тривиальным способом:
заходим в cmd и пишем: </p>

<p class="quote">help</p>

<p>В сообщении я не буду подробно рассматривать команды типа copy (т.е. совсем тривиальные) так как о них можно прочитать введя команду типа</p>

<p class="quote">copy /?</p>
<h4>1. Ввод-вывод</h4>
<p>Рассмотреть же я попытаюсь команды, которые в основном хэлпе не написаны или описаны недостаточно подробно. Для начала хотелось бы написать про операторы перенаправления ввода-вывода.
Таковыми операторами являются >, >>, <.
Они нам могут пригодиться как минимум в трех ситуациях:</p>
<ol>
	<li>Просмотр логов бат-файла</li>
	<li>Чтение длинных хелпов по консольным утилитам</li>
	<li>Подхватывание каких-либо переменных из лежащего рядом файла</li>
</ol>
<p>При желании примеров можно придумать сколько угодно.</p>

<p>Из командной строки эти возможности реализуются следующим образом. Для того, чтобы перенаправить текстовые сообщения, выводимые какой-либо командой, в текстовый файл, нужно использовать конструкцию</p>
<p class="quote">команда > имя_файла</p>

<p>Если при этом заданный для вывода файл уже существовал, то он перезаписывается (старое содержимое теряется), если не существовал — создается. Можно также не создавать файл заново, а дописывать информацию, выводимую командой, в конец существующего файла. Для этого команда перенаправления вывода должна быть задана так:</p>
<p class="quote">команда >> имя_файла</p>

<p>С помощью символа < можно прочитать входные данные для заданной команды не с клавиатуры, а из определенного (заранее подготовленного) файла:</p>
<p class="quote">команда < имя_файла</p>

<p>Приведем несколько примеров перенаправления ввода/вывода.</p>
<ol>
	<li>Вывод встроенной справки для команды COPY в файл copy.txt:
	<p class="quote">COPY /? > copy.txt</p></li>
	<li>Добавление текста справки для команды XCOPY в файл copy.txt:
	<p class="quote">XCOPY /? >> copy.txt</p></li>
	<li>Ввод новой даты из файла date.txt (DATE — это команда для просмотра и изменения системной даты):
	<p class="quote">DATE < date.txt</p></li>
</ol>

<h4>2. FOR...DO</h4>
Второй командой, которую бы хотелось рассмотреть является FOR ... DO
Эта команда, так же как и многие другие достаточно подробно описана на сайте WindowsFAQ.
Я же хочу остановиться на двух наиболее важных пунктах

2.1 Переменные


%~I
Расширение %I, которое удаляет окружающие кавычки ("").
%~fI
Расширение %I до полного имени пути.
%~dI
Замена %I именем диска.
%~pI
Замена %I на путь.
%~nI
Замена %I одним именем файла.
%~xI
Замена %I расширением имени файла.
%~sI
Замена путем, содержащим только короткие имена.
%~aI
Замена %I атрибутами файла.
%~tI
Замена %I временем модификации файла.
%~zI
Замена %I размером файла.
%~$PATH:I
Поиск в каталогах, перечисленных в переменной среды PATH, и замена %I полным именем первого найденного файла. Если переменная среды не определена или поиск не обнаружил файлов, модификатор выдает пустую строку.


Очевидно, что с помощью такого широкого набора переменных мы можем практически полностью отвязаться от индивидуальных особенностей конкретного экземпляра операционной системы и => избежать проблем например из-за того, что система встала на диск E:, а не на C:.

2.2 Работа с файлами


Чтобы произвести разбор файла, игнорируя комментарии, можно использовать следующую команду:

for /F "eol=; tokens=2,3* delims=," %i in (myfile.txt) do @echo %i %j %k

Данная команда производит разбор каждой строки в файле Myfile.txt, игнорируя строки, начинающиеся с точки с запятой, и передает второй и третий элементы из каждой строки в тело цикла команды FOR. Элементы разделяются запятыми и/или пробелами. Тело инструкции FOR использует %i для получения второго элемента, %j для получения третьего элемента и %k для получения оставшихся элементов в строке. Если имена файлов содержат пробелы, их следует заключать в кавычки (например, «ИмяФайла»). Для использования кавычек необходима команда usebackq. В противном случае кавычки рассматриваются как определение символьной строки для разбора.

Переменная %i объявлена явно в инструкции FOR, а %j и %k объявлены неявно с помощью tokens=. С помощью tokens= можно указать до 26 элементов, если это не вызовет попытки объявить переменную с именем, большим буквы «z» или «Z».

Для разбора вывода команды с помощью помещения параметра МножествоИменФайлов в скобки можно использовать следующую команду:
for /F "usebackq delims==" %i IN (`set`) DO @echo %i

В данном примере перечисляются имена переменных среды в текущем окружении.

Пофантазируем?..


Итак, что нам дают всего эти две команды?

Ну вот возьмем для примера утилиту, которая лежит на сайте Microsoft и называется psexec. Она позволяет нам, зная логин и пароль машины, подключиться к ней и выполнить произвольные действия в консольном режиме
Допустим, что у нас есть домен Windows и пароль доменного администратора.
Нам нужно подключиться ко всем машинам и удалить все файлы с маской *.mp3 с диска C:.

Для начала — как получить список всех компьютеров сети.
Я это делаю так: 

FOR /F "skip=3 delims=\ " %%A IN ('NET VIEW') DO ECHO %%A>>c:\comps.txt

Имеем список всех компов в сети в столбик — как раз в том формате, который принимает psexec.
Правда, будут проблемы с русскими названиями компов, но это ведь не актуальная проблема, да?

Теперь про PsExec. Скачать его можно тут.
Синтаксис описан там же.

Нас интересует вот какая команда
c:\psexec.exe @c:\comps.txt -u username -p password -c MP3DELETE.bat

Содержимое .bat — файла:
cd /d c:\
for /r %%p in (*.mp3) do del %%p

Само собой, задача чисто абстрактная. Мне просто хотелось показать, что консоль в Windows на самом деле весьма могуча и позволяет красиво и удобно решать многие задачи.

А уж как здорово одним нажатием на bat-ник устанавливать пользователям софт в unattended-режиме…

Спасибо за внимание! Жду критики и предложений…

UPD.1 Спасибо большое maxshopen за инвайт и первую карму! 
Благодаря ему и всем плюсующим с радостью перенес свою первую статью в свой первый блог — Windows.

UPD.2 Спасибо, Hint

copy con file.txt
Перенаправляет вывод с клавиатуры в файл (CTRL+Z — завершение ввода).
type file.txt >prn
Печает на принтере file.txt

UPD.3 Дамы и Господа!
Осознал, что можно на эту тему еще писать и писать.
У кого-нибудь есть какие-нибудь конкретные пожелания?
Или мне самому тему придумать?
Если пожелания есть, то пишите в кАментах.
	</body>
</html>