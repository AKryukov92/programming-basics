<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<style>
		elven {
			color:darkgrey;
		}
		elven origin {
			display:none;
		}
		elven:hover origin {
			display:inline;
		}
		elven trans {
			display:inline;
		}
		elven:hover trans {
			display:none;
		}
		.comment{
			color:darkgrey;
		}
		.code {
			font-family:monospace;
			display:block;
			white-space:pre;
		}
		</style>
	</head>
	<body>
	Цитата из книги "Совершенный код" с комментариями. Автор: С.Макконнел
	<p>Купить всю книгу можно на следующих сайтах:
	<ul>
		<li><a href="http://www.ozon.ru/context/detail/id/138437220/">ozon.ru</a></li>
		<li><a href="https://market.yandex.ru/product--makkonnell-s-sovershennyi-kod-master-klass/1545077">market.yandex.ru</a></li>
	</ul>
	</p>
	<h1>Защитное программирование</h1>
<h3>8.2. Утверждения</h3>
<!--Вопросы по тексту:
* Как оформлять утверждения на языке программирования?
* Как активировать утверждения в используемой технологии?
* Происходит ли вызов методов внутри утверждений в используемой технологии?
* Можно ли показывать сообщения от сработанных утверждений конечному пользователю?
-->

<p>Утверждение (assertion) — это код (обычно метод или макрос), используемый во время разработки, с помощью которого программа проверяет правильность своего выполнения. Если утверждение истинно, то все работает так, как ожидалось. Если ложно — значит, в коде обнаружена ошибка. Например, если система предполагает, что длина файла с информацией о заказчиках никогда не будет превышать 50 000 записей, программа могла бы содержать утверждение, что число записей меньше или равно 50 000. Пока это число меньше или равно 50 000, утверждение будет хранить молчание. Но как только записей станет больше 50 000, оно громко провозгласит об ошибке в программе.</p>
<p>Утверждения особенно полезны в больших и сложных программах, а также в программах, требующих высокой надежности. Они позволяют нам быстрее выявить несоответствия в интерфейсах, ошибки, вкравшиеся при изменении кода и т. п.</p>
<p>Обычно утверждение принимает два аргумента: логическое выражение, описывающее предположение, которое должно быть истинным, и сообщение, выводимое в противном случае. <elven><origin>Вот как будет выглядеть утверждение на языке Java</origin><trans>Вот как будут выглядеть утверждения на различных языках<trans></elven>, если переменная denominator должна быть ненулевой:</p>
<p class="comment">Пример утверждения (C#)<br/>
<span class="code">
	Debug.Assert(denominator != 0, "Знаменатель оказался равен 0");
</span>
</p>
<p>Пример утверждения (Java)
<span class="code">
	assert denominator != 0 : ”Знаменатель оказался равен 0.”;
</span>
</p>
<p class="comment">В JavaScript отсутствует встроенная поддержка утверждений. При необходимости, можно воспользоваться одним из готовых решений в интернете.</p>
<p>
<p>В этом утверждении объявляется, что denominator не должен быть равен 0. Первый аргумент — denominator != 0 — логическое выражение, принимающее значение true или false. Второй — это сообщение, выводимое, когда первый аргумент равен false (т. е. утверждение ложно). Используйте утверждения, чтобы документировать допущения, сделанные в коде, и чтобы выявить непредвиденные обстоятельства. Например, утверждения можно применять при проверке таких условий:
<ul>
<li>значение входного (выходного) параметра попадает в ожидаемый интервал;</li>
<li>файл или поток открыт (закрыт), когда метод начинает (заканчивает) выполняться;</li>
<li>указатель файла или потока находится в начале (конце), когда метод начинает (заканчивает) выполняться;</li>
<li>файл или поток открыт только для чтения, только для записи или для чтения и записи;</li>
<li>значение входной переменной не изменяется в методе;</li>
<li>указатель ненулевой;</li>
<li>массив или другой контейнер, передаваемый в метод, может вместить по крайней мере X элементов;</li>
<li>таблица инициализирована для помещения реальных значений;</li>
<li>контейнер пуст (заполнен), когда метод начинает (заканчивает) выполняться;</li>
<li>результаты работы сложного, хорошо оптимизированного метода совпадают с результатами метода более медленного, но написанного яснее.</li>
</ul>
<p>Разумеется, это только основы, и ваши методы будут содержать много более специфических допущений, которые вы сможете документировать, используя утверждения.</p>
<p>Утверждения не предназначены для показа сообщений в промышленной версии — они в основном применяются при разработке и поддержке. Обычно их добавляют при компиляции кода во время разработки и удаляют при компиляции промышленной версии. В период разработки утверждения выявляют противоречивые допущения, непредвиденные условия, некорректные значения, переданные методам, и т. п. При компиляции промышленной версии они могут быть удалены и, таким образом, не повлияют на производительность системы.</p>
<p class="comment">В Java по-умолчанию утверждения отключены. Для их включения, нужно запустить программу с опцией виртуальной машины -enableassertions.</p>
<p class="comment">В C# при создании проекта в Visual Studio активность утверждений зависит от конфигурации запуска. Можно переключать режим запуска между "Release" (утверждения отключены) и "Debug" (утверждения включены).</p>


<h3>Общие принципы использования утверждений</h3>
<p>Далее перечислены общие положения по применению утверждений.</p>

<p><b>Используйте процедуры обработки ошибок для ожидаемых событий и утверждения для событий, которые происходить не должны</b> Утверждения проверяют условия событий, которые никогда не должны происходить. Обработчик ошибок проверяет внештатные события, которые могут и не происходить слишком часто, но были предусмотрены писавшим код программистом и должны обрабатываться и в промышленной версии. Обработчик ошибок обычно проверяет некорректные входные данные, утверждения — ошибки в программе.</p>
<p>Если для обработки аномальной ситуации служит обработчик ошибок, он позволит программе адекватно отреагировать на ошибку. Если же в случае аномальной ситуации сработало утверждение, для исправления просто отреагировать на ошибку мало — необходимо изменить исходный код программы, перекомпилировать и выпустить новую версию ПО.</p>
<p>Будет правильно рассматривать утверждения как выполняемую документацию — работать программу с их помощью вы не заставите, но вы можете документировать допущения в коде более активно, чем это делают комментарии языка программирования.</p>

<p><b>Старайтесь не помещать выполняемый код в утверждения</b> Если в утверждении содержится код, возникает возможность удаления этого кода компилятором при отключении утверждений. <span class="comment">Это актуально как для Java, так и для C#.</span> Допустим, у вас есть следующее утверждение:
<p>Пример опасного использования утверждения (Visual Basic)
<span class="code">
	Debug.Assert( PerformAction() ) ’ Невозможно выполнить действие.
</span>
</p>
Проблема здесь в том, что, если вы не компилируете утверждения, вы не компилируете и код, который выполняет указанное действие. Вместо этого поместите выполняемые
выражения в отдельных строках, присвойте результаты статусным переменным и проверяйте значения этих переменных. Вот пример безопасного использования утверждения:
<p>Пример безопасного использования утверждения (Visual Basic)<br>
<span class="code">
	actionPerformed = PerformAction()
	Debug.Assert( actionPerformed)’ Невозможно выполнить действие.
</span></p>
<p><b>Используйте утверждения для документирования и проверки предусловий и постусловий</b> Предусловия и постусловия — это часть подхода к проектированию и разработке программ, известному как «проектирование по контракту» (Meyer, 1997). При использовании пред- и постусловий каждый метод или класс заключает контракт с остальной частью программы.</p>
<p><i>Предусловия</i> — это соглашения, которые клиентский код, вызывающий метод или класс, обещает выполнить до вызова метода или создания экземпляра объекта. Предусловия — это обязательства клиентского кода перед кодом, который он вызывает.</p>
<p><i>Постусловия</i> — это соглашения, которые метод или класс обещает выполнить при завершении своей работы. Постусловия — это обязательства метода или класса перед кодом, который их использует.</p>
<p>Утверждения — удобный инструмент для документирования пред- и постусловий. С этой целью можно использовать и комментарии, но в отличие от них утверждения могут динамически проверять, выполняются ли пред- и постусловия.</p>
<p>В следующем примере утверждения документируют пред- и постусловия в функции Velocity:</p>
<p>Пример использования утверждений для документирования пред- и постусловий (Visual Basic)
<span class="code">
	Private Function Velocity ( _
	ByVal latitude As Single, _
	ByVal longitude As Single, _
	ByVal elevation As Single _
	) As Single
	’ Предусловия
	Debug.Assert ( -90 <= latitude And latitude <= 90 )
	Debug.Assert ( 0 <= longitude And longitude < 360 )
	Debug.Assert ( -500 <= elevation And elevation <= 75000 )
	...
	’ Постусловия
	Debug.Assert ( 0 <= returnVelocity And returnVelocity <= 600 )
	’ Возвращаемое значение
	Velocity = returnVelocity
	End Function
</span>
<p>Если бы переменные latitude, longitude и elevation поступили из внешнего источника, корректность их значений должна была быть проверена и обработана в коде обработчика ошибок, а не с помощью утверждений. Но если эти переменные поступили из доверенного внутреннего источника, а метод спроектирован в предположении, что их значения будут в разрешенном интервале, то применение утверждений допустимо.</p>
<p><b>Для большей устойчивости кода проверяйте утверждения, а затем все равно обработайте возможные ошибки</b> Каждая потенциально ошибочная ситуация обычно проверяется или утверждением, или кодом обработчика ошибок, но не тем и другим вместе. Некоторые эксперты утверждают, что необходим только один тип проверки (Meyer, 1997).</p>
<p>Однако реальные программы и проекты бывают слишком запутанными, чтобы можно было полагаться на одни лишь утверждения. В больших, долгоживущих системах различные части могут разрабатываться несколькими проектировщиками 5–10 лет и более. Разработка будет производиться в разное время и в разных версиях продукта. Эти проекты будут основаны на разных технологиях и сосредото чены на различных вопросах разработки системы. Проектировщики могут быть удалены друг от друга географически, особенно если элементы системы приобретались у независимых компаний. Программисты будут использовать различные стандарты кодирования в разное время жизни системы. В большой команде разработчиков некоторые неминуемо будут добросовестнее других, поэтому часть кода будет проверяться более тщательно, чем остальная. В любом случае, когда тестовые команды работают в нескольких географических регионах, а требования бизнеса приводят к изменению тестового покрытия от версии к версии, рассчитывать на всестороннее низкоуровневое тестирование системы нельзя.</p>
<p>В этих обстоятельствах одна и та же ошибка может быть проверена и с помощью утверждения, и обработчиком ошибок. Так, в исходном коде Microsoft Word условия, которые должны быть истинными, сперва помещаются в утверждения, а затем и в коде обработки ошибок рассматривается ситуация, когда утверждение ложно. В столь сложных и долгоживущих приложениях, как Word, утверждения служат для выявления как можно большего числа ошибок периода разработки. Но поскольку приложение очень сложное (миллионы строк кода) и прошло через столько изменений, неразумно ожидать обнаружения и исправления всех мыслимых ошибок до начала поставки приложения пользователям. Поэтому ошибки
должны обрабатываться и в промышленной версии системы.</p>
<p>Вот как это можно сделать на примере функции Velocity:</p>
<p>Пример использования утверждений для документирования пред- и постусловий (Visual Basic)
<span class="code">Private Function Velocity ( _
ByRef latitude As Single, _
ByRef longitude As Single, _
ByRef elevation As Single _
) As Single
’ Предусловия
</span>
</p>
<p>Так выглядит код утверждения:
<span class="code">
Debug.Assert ( -90 <= latitude And latitude <= 90 )
Debug.Assert ( 0 <= longitude And longitude < 360 )
Debug.Assert ( -500 <= elevation And elevation <= 75000 )
...
’ Откорректируйте входные данные. Значения должны попадать
’ в интервалы, указанные в вышестоящих утверждениях. Иначе
’ они будут заменены ближайшими допустимыми значениями.
</span>
</p>
<p>Таким может быть код, обрабатывающий неверные входные данные во время выполнения программы.
<span class="code">
If ( latitude < -90 ) Then
latitude = -90
ElseIf ( latitude > 90 ) Then
latitude = 90
End If
If ( longitude < 0) Then
longitude = 0
ElseIf ( longitude > 360 ) Then
...
</span>
</p>
	</body>
</html>